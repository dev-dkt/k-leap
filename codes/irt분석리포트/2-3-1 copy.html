<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>한국어능력시험 개인 능력 프로파일</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="report-styles.css" />
    <!-- Chart.js 라이브러리 로드 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- math.js 라이브러리 로드 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
  </head>
  <body>
    <div class="container">
      <h1>한국어능력시험 개인 능력 프로파일</h1>

      <div class="section">
        <h2>4. 전체 분포 내 위치</h2>
        <div class="chart-container">
          <canvas id="distributionChart"></canvas>
        </div>
        <p>위 그래프는 전체 응시자의 능력 분포를 나타냅니다.</p>
      </div>
    </div>

    <!-- 스크립트 시작 -->
    <script type="module">
      import {
        df_questions,
        df_responses,
        df_questions_speaking,
        df_responses_speaking,
        speaking_grading_criteria,
      } from "./data2.js";

      // 소수점 2자리로 반올림하는 함수
      function round2(num) {
        return Math.round((num + Number.EPSILON) * 100) / 100;
      }

      // 필기 시험과 말하기 시험 데이터 결합
      const combinedResponses = df_responses.map((response) => {
        const speakingResponse = df_responses_speaking.find(
          (sr) => sr.외국인등록번호 === response.외국인등록번호
        );
        if (speakingResponse) {
          return {
            ...response,
            speaking_theta: parseFloat(speakingResponse["능력 추정치 (theta)"]),
            overall_theta:
              (parseFloat(response["능력 추정치 (theta)"]) +
                parseFloat(speakingResponse["능력 추정치 (theta)"])) /
              2,
          };
        }
        return {
          ...response,
          overall_theta: parseFloat(response["능력 추정치 (theta)"]),
        };
      });

      // 말하기 시험에 응시한 수험생 필터링
      const validExaminees = combinedResponses.filter(
        (r) => r.speaking_theta !== undefined
      );

      // 무작위로 한 수험생 선택 (말하기 시험도 응시한 수험생 중에서)
      const examinee =
        validExaminees[Math.floor(Math.random() * validExaminees.length)];

      // 전체 수험생의 능력 추정치 배열 생성
      const allAbilities = validExaminees.map((e) => e.overall_theta);

      // 수험생의 능력 추정치
      const examineeAbility = examinee.overall_theta;

      // 능력 추정치를 오름차순으로 정렬
      const sortedAbilities = allAbilities.slice().sort((a, b) => a - b);

      // 수험생의 순위 및 백분위수 계산
      const examineeIndex = sortedAbilities.findIndex(
        (ability) => ability >= examineeAbility
      );
      const percentileRank =
        ((validExaminees.length - examineeIndex - 1) /
          (validExaminees.length - 1)) *
        100;

      // KDE를 사용하여 능력 분포 추정
      function kernelDensityEstimation(kernel, X) {
        return function (V) {
          return X.map(function (x) {
            return [
              x,
              math.mean(
                V.map(function (v) {
                  return kernel(x - v);
                })
              ),
            ];
          });
        };
      }

      // 가우시안 커널 함수 정의
      function gaussianKernel(scale) {
        return function (u) {
          return (
            (1 / (scale * Math.sqrt(2 * Math.PI))) *
            Math.exp(-0.5 * ((u / scale) * (u / scale)))
          );
        };
      }

      // 능력 추정치의 범위 설정
      const minAbility = Math.min(...allAbilities);
      const maxAbility = Math.max(...allAbilities);

      // X축 값을 위한 배열 생성
      const xValues = math
        .range(minAbility - 0.5, maxAbility + 0.5, 0.05, true)
        .toArray();

      // KDE 계산
      const bandwidth = 0.3; // 또는 데이터에 맞게 조정 가능
      const kde = kernelDensityEstimation(gaussianKernel(bandwidth), xValues);
      const densityEstimates = kde(allAbilities);

      // 수험생의 위치에 해당하는 밀도 값 찾기
      const examineeDensity = densityEstimates.find(
        (d) => round2(d[0]) === round2(examineeAbility)
      );

      // 만약 정확한 x값이 없으면 보간법으로 y값 추정
      let examineeY = 0;
      if (examineeDensity) {
        examineeY = examineeDensity[1];
      } else {
        // 가까운 두 점을 찾아서 선형 보간
        for (let i = 0; i < densityEstimates.length - 1; i++) {
          const x1 = densityEstimates[i][0];
          const x2 = densityEstimates[i + 1][0];
          if (examineeAbility >= x1 && examineeAbility <= x2) {
            const y1 = densityEstimates[i][1];
            const y2 = densityEstimates[i + 1][1];
            // 선형 보간 공식
            examineeY = y1 + ((examineeAbility - x1) * (y2 - y1)) / (x2 - x1);
            break;
          }
        }
      }

      // 차트 데이터 생성
      const labels = densityEstimates.map((d) => d[0]);
      const data = densityEstimates.map((d) => d[1]);

      // 차트 생성
      const distributionCtx = document
        .getElementById("distributionChart")
        .getContext("2d");

      const distributionChart = new Chart(distributionCtx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: "능력 분포",
              data: data,
              fill: true,
              backgroundColor: "rgba(75, 192, 192, 0.2)",
              borderColor: "rgba(75, 192, 192, 1)",
              tension: 0.3,
              pointRadius: 0, // 포인트 표시 안 함
            },
            {
              label: "당신의 위치",
              data: [
                {
                  x: examineeAbility,
                  y: examineeY,
                },
              ],
              backgroundColor: "rgba(255, 99, 132, 1)",
              type: "scatter",
              pointRadius: 8,
            },
          ],
        },
        options: {
          scales: {
            x: {
              type: "linear",
              position: "bottom",
              title: {
                display: true,
                text: "능력 추정치 (theta)",
              },
            },
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: "밀도",
              },
            },
          },
        },
      });

      // 수험생의 순위 및 백분위수 정보 업데이트
      document.querySelector(
        ".section p"
      ).textContent = `위 그래프는 전체 응시자의 능력 분포를 나타냅니다. 당신은 총 ${
        validExaminees.length
      }명 중 ${validExaminees.length - examineeIndex}등으로, 상위 ${round2(
        percentileRank
      )}%에 해당합니다. 당신의 능력 추정치 (theta)는 ${round2(
        examineeAbility
      )}입니다.`;
    </script>
    <!-- 스크립트 종료 -->
  </body>
</html>
